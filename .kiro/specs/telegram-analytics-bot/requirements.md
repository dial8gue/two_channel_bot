# Requirements Document

## Introduction

Telegram-бот для анализа сообщений в групповых чатах с использованием OpenAI SDK. Бот собирает сообщения за заданный период, анализирует их с помощью LLM и предоставляет краткую сводку: кто о чем говорил, самые обсуждаемые посты и кто больше всего собрал реакций. Включает административную панель для управления настройками, систему кеширования для экономии токенов и режим отладки.

## Glossary

- **Bot**: Telegram-бот, разработанный с использованием библиотеки Aiogram
- **Admin**: Главный администратор бота, указанный в переменных окружения
- **Group Chat**: Групповой чат Telegram, в котором Bot анализирует сообщения
- **Analysis Period**: Период времени в часах, за который Bot анализирует сообщения (по умолчанию 24 часа)
- **Storage Period**: Максимальный период хранения сообщений в базе данных
- **Debug Mode**: Режим работы, при котором Bot отправляет результаты анализа только Admin в личные сообщения
- **Database**: SQLite база данных для хранения сообщений и метаданных
- **OpenAI SDK**: Библиотека для взаимодействия с API OpenAI для анализа сообщений
- **Cache**: Система кеширования ответов от OpenAI SDK для экономии токенов
- **Debounce**: Механизм предотвращения частых повторных запросов к OpenAI API

## Requirements

### Requirement 1

**User Story:** Как пользователь группового чата, я хочу получать краткую сводку обсуждений за день, чтобы быстро понять основные темы и активность участников

#### Acceptance Criteria

1. WHEN Admin отправляет команду запроса анализа, THE Bot SHALL извлечь все сообщения из Database за последние 24 часа
2. WHEN Bot получает сообщения для анализа, THE Bot SHALL отправить данные в OpenAI SDK для генерации краткой сводки
3. THE Bot SHALL включить в сводку информацию о том, кто о чем говорил
4. THE Bot SHALL включить в сводку список самых обсуждаемых постов с прямыми ссылками на них
5. THE Bot SHALL включить в сводку информацию о пользователях, которые собрали больше всего реакций

### Requirement 2

**User Story:** Как администратор, я хочу настраивать период анализа сообщений, чтобы получать сводки за разные временные интервалы

#### Acceptance Criteria

1. THE Bot SHALL поддерживать переменную окружения для указания Analysis Period в часах
2. WHEN Admin запрашивает анализ с указанием периода, THE Bot SHALL использовать указанный период вместо значения по умолчанию
3. WHEN Bot извлекает сообщения для анализа, THE Bot SHALL ограничить выборку указанным Analysis Period
4. THE Bot SHALL валидировать, что Analysis Period является положительным числом

### Requirement 3

**User Story:** Как администратор, я хочу использовать режим отладки, чтобы тестировать функционал бота без отправки сообщений в групповой чат

#### Acceptance Criteria

1. THE Bot SHALL поддерживать переменную окружения DEBUG_MODE для активации режима отладки
2. WHEN DEBUG_MODE активирован, THE Bot SHALL отправлять все результаты анализа только Admin в личные сообщения
3. WHEN DEBUG_MODE деактивирован, THE Bot SHALL отправлять результаты анализа в Group Chat
4. THE Bot SHALL поддерживать переменную окружения ADMIN_ID для идентификации Admin

### Requirement 4

**User Story:** Как администратор, я хочу управлять настройками бота через личный чат, чтобы не использовать конфигурационные файлы для изменения параметров

#### Acceptance Criteria

1. WHEN Admin отправляет команду очистки базы данных, THE Bot SHALL удалить все сообщения из Database
2. WHEN Admin отправляет команду настройки Storage Period, THE Bot SHALL обновить максимальный период хранения сообщений
3. WHEN Admin отправляет команду настройки Analysis Period, THE Bot SHALL обновить период анализа по умолчанию
4. WHEN Admin отправляет команду остановки сохранения, THE Bot SHALL прекратить сохранение новых сообщений в Database
5. WHEN Admin отправляет команду запуска сохранения, THE Bot SHALL возобновить сохранение новых сообщений в Database

### Requirement 5

**User Story:** Как владелец бота, я хочу автоматически удалять старые сообщения из базы данных, чтобы предотвратить неконтролируемый рост размера базы данных

#### Acceptance Criteria

1. THE Bot SHALL поддерживать переменную окружения STORAGE_PERIOD для указания максимального периода хранения в часах
2. WHEN Bot запускается, THE Bot SHALL удалить все сообщения из Database старше Storage Period
3. WHEN Bot сохраняет новое сообщение, THE Bot SHALL проверить и удалить сообщения старше Storage Period
4. THE Bot SHALL выполнять очистку старых сообщений не чаще одного раза в час

### Requirement 6

**User Story:** Как владелец бота, я хочу настраивать параметры подключения к OpenAI API, чтобы использовать разные модели и совместимые API endpoints

#### Acceptance Criteria

1. THE Bot SHALL поддерживать переменную окружения OPENAI_BASE_URL для указания базового URL API
2. THE Bot SHALL поддерживать переменную окружения OPENAI_MODEL для указания используемой модели
3. WHEN OPENAI_BASE_URL не указан, THE Bot SHALL использовать стандартный endpoint OpenAI API
4. WHEN OPENAI_MODEL не указан, THE Bot SHALL использовать модель по умолчанию
5. THE Bot SHALL валидировать наличие OPENAI_API_KEY при инициализации

### Requirement 7

**User Story:** Как владелец бота, я хочу минимизировать расход токенов OpenAI, чтобы снизить операционные расходы

#### Acceptance Criteria

1. WHEN Bot получает запрос на анализ, THE Bot SHALL проверить Cache на наличие результата для идентичного набора сообщений
2. WHEN результат найден в Cache, THE Bot SHALL вернуть кешированный результат без обращения к OpenAI SDK
3. WHEN Bot получает новый результат от OpenAI SDK, THE Bot SHALL сохранить результат в Cache
4. THE Bot SHALL поддерживать переменную окружения CACHE_TTL для указания времени жизни кеша в минутах
5. THE Bot SHALL поддерживать переменную окружения MAX_TOKENS для ограничения максимального количества токенов в запросе

### Requirement 8

**User Story:** Как владелец бота, я хочу предотвратить частые повторные запросы к OpenAI API, чтобы избежать превышения лимитов и лишних расходов

#### Acceptance Criteria

1. WHEN Bot получает запрос на анализ, THE Bot SHALL проверить время последнего запроса анализа
2. WHEN последний запрос был выполнен менее чем DEBOUNCE_INTERVAL секунд назад, THE Bot SHALL отклонить новый запрос с информативным сообщением
3. WHEN последний запрос был выполнен более чем DEBOUNCE_INTERVAL секунд назад, THE Bot SHALL обработать новый запрос
4. THE Bot SHALL поддерживать переменную окружения DEBOUNCE_INTERVAL для указания минимального интервала между запросами в секундах

### Requirement 9

**User Story:** Как пользователь группового чата, я хочу, чтобы бот автоматически сохранял все сообщения, чтобы они были доступны для последующего анализа

#### Acceptance Criteria

1. WHEN новое сообщение появляется в Group Chat, THE Bot SHALL сохранить текст сообщения в Database
2. WHEN новое сообщение появляется в Group Chat, THE Bot SHALL сохранить метаданные сообщения (автор, время, идентификатор) в Database
3. WHEN сообщение получает реакции, THE Bot SHALL обновить информацию о реакциях в Database
4. WHEN сохранение сообщений остановлено Admin, THE Bot SHALL игнорировать новые сообщения

### Requirement 10

**User Story:** Как разработчик, я хочу иметь автоматизированные тесты для основного функционала, чтобы обеспечить надежность и упростить поддержку кода

#### Acceptance Criteria

1. THE Bot SHALL включать тесты для функционала сохранения сообщений в Database
2. THE Bot SHALL включать тесты для функционала анализа сообщений
3. THE Bot SHALL включать тесты для административных команд
4. THE Bot SHALL включать тесты для системы кеширования
5. THE Bot SHALL включать тесты для механизма debounce

### Requirement 11

**User Story:** Как DevOps инженер, я хочу развернуть бота в Docker контейнере, чтобы упростить развертывание и обеспечить изоляцию окружения

#### Acceptance Criteria

1. THE Bot SHALL включать Dockerfile для создания образа контейнера
2. THE Bot SHALL включать docker-compose.yml для упрощенного запуска
3. WHEN Bot запускается в контейнере, THE Bot SHALL корректно читать переменные окружения
4. WHEN Bot запускается в контейнере, THE Bot SHALL сохранять Database в примонтированном volume
